<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIRCARGOTRACK | Rastreo</title>
  <style>
    :root{
      --azulClaro:#38bdf8; --azulOscuro:#1e3a8a;
      --celesteTxt:#0ea5e9; --celesteBg:#e0f2fe;
      --gris:#f1f5f9; --gris2:#e2e8f0;
      --blanco:#ffffff; --texto:#0f172a;
      --amarilloP√°lido:#fde68a; --amarilloP√°lidoHover:#fcd34d;
    }

    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--texto);background:var(--gris);}
    header{
      background:linear-gradient(90deg,var(--azulClaro),var(--azulOscuro));
      color:var(--blanco);
      position:relative;
      padding:35px 20px 45px;
      box-shadow:0 2px 8px rgba(0,0,0,.25);
      text-align:center;
    }

    .flag-left, .flag-right{
      position:absolute;
      top:18px;
      width:85px;
      height:auto;
      border-radius:6px;
      box-shadow:0 0 6px rgba(0,0,0,.4);
    }
    .flag-left{left:25px;}
    .flag-right{right:25px;}

    .logo svg{max-width:480px;width:90%;height:auto;}
    .container{max-width:900px;margin:24px auto;padding:0 12px;display:flex;flex-direction:column;gap:14px;}
    .card{background:var(--blanco);border:1px solid var(--gris2);border-radius:12px;box-shadow:0 3px 12px rgba(2,6,23,.06);overflow:hidden;}
    .card-title{padding:10px 12px;font-weight:800;color:var(--texto);border-bottom:1px solid var(--gris2);background:#fafafa;font-size:16px;}
    .card-header{padding:10px 12px;border-bottom:1px solid var(--gris2);display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;}
    .input{display:flex;align-items:center;gap:8px;border:1px solid var(--gris2);border-radius:8px;padding:8px 10px;background:var(--blanco);}
    .input input{width:100%;border:none;outline:none;font-size:14px;}
    .btn{border:none;background:var(--amarilloP√°lido);color:#1f2937;padding:8px 12px;font-weight:700;border-radius:10px;cursor:pointer;}
    .btn:hover{background:var(--amarilloP√°lidoHover);}
    .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;}
    table{width:100%;border-collapse:collapse;min-width:620px;}
    th,td{padding:8px 10px;border-bottom:1px solid var(--gris2);text-align:left;font-size:13px;vertical-align:middle;}
    tbody tr:hover{background:#f9fafb;}
    .empty{padding:16px;text-align:center;color:#64748b;font-size:13px;line-height:1.4;}
    .meta{font-size:12px;color:#475569;margin-left:auto;}
    .view-btn{
      background:var(--celesteTxt);
      color:#fff;
      border:none;
      padding:7px 12px;
      border-radius:8px;
      cursor:pointer;
      font-size:12px;
      font-weight:800;
      box-shadow:0 1px 3px rgba(0,0,0,.15);
      transition:all .25s ease;
    }
    .view-btn:hover{background:#0284c7;transform:scale(1.05);}
    .footer-btn{margin:30px auto;text-align:center;}
    .btn-refresh{background:var(--celesteTxt);color:#fff;border:none;padding:10px 26px;font-weight:800;border-radius:12px;cursor:pointer;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.2);transition:all .25s ease;}
    .btn-refresh:hover{background:#0ea5e9;transform:scale(1.05);}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <header>
    <img class="flag-left" src="https://flagcdn.com/us.svg" alt="USA">
    <img class="flag-right" src="https://flagcdn.com/ni.svg" alt="Nicaragua">
    <div class="logo">
      <svg viewBox="0 0 520 120" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="MIRCARGOTRACK logo">
        <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="0">
          <stop offset="0" stop-color="#38bdf8"/><stop offset="1" stop-color="#1e3a8a"/></linearGradient></defs>
        <g font-family="Inter, system-ui, Segoe UI, Roboto, Arial" text-anchor="middle">
          <text x="260" y="58" font-size="54" font-weight="900" fill="#fff" style="letter-spacing:1px; font-style:italic;">
            MIRCARGO<tspan fill="#fde68a">TRACK</tspan>
          </text>
          <path d="M70 70 L450 70 L466 86 L70 86 Z" fill="url(#g)" opacity="0.9">
            <animate attributeName="opacity" values="0.4;1;0.4" dur="2.5s" repeatCount="indefinite"/>
          </path>
        </g>
      </svg>
    </div>
  </header>

  <main class="container">
    <section class="card" id="cardMaritimo">
      <div class="card-title">üö¢ Rastreo Mar√≠timo</div>
      <div class="card-header">
        <div class="input"><input id="searchMaritimo" placeholder="N√∫mero de rastreo (Mar√≠timo o Entrega Mar√≠timo)" /></div>
        <button class="btn" onclick="searchTracking('Maritimo')">Buscar</button>
        <div id="metaMaritimo" class="meta"></div>
      </div>
      <div class="table-wrap"><table><thead id="theadMaritimo"></thead><tbody id="tbodyMaritimo"></tbody></table></div>
      <div id="emptyMaritimo" class="empty" style="display:none;">‚ùå No encontramos ese n√∫mero de rastreo.</div>
    </section>

    <section class="card" id="cardAereo">
      <div class="card-title">‚úàÔ∏è Rastreo A√©reo</div>
      <div class="card-header">
        <div class="input"><input id="searchAereo" placeholder="N√∫mero de rastreo (A√©reo o Entrega A√©reo)" /></div>
        <button class="btn" onclick="searchTracking('Aereo')">Buscar</button>
        <div id="metaAereo" class="meta"></div>
      </div>
      <div class="table-wrap"><table><thead id="theadAereo"></thead><tbody id="tbodyAereo"></tbody></table></div>
      <div id="emptyAereo" class="empty" style="display:none;">‚ùå No encontramos ese n√∫mero de rastreo.</div>
    </section>

    <section class="card" id="cardCompra">
      <div class="card-title">üõçÔ∏è Rastreo de compra en l√≠nea</div>
      <div class="card-header">
        <div class="input"><input id="searchCompra" placeholder="Nombre o n√∫mero de tracking" /></div>
        <button class="btn" onclick="searchTracking('Compra')">Buscar</button>
        <div id="metaCompra" class="meta"></div>
      </div>
      <div class="table-wrap"><table><thead id="theadCompra"></thead><tbody id="tbodyCompra"></tbody></table></div>
      <div id="emptyCompra" class="empty" style="display:none;">‚ö†Ô∏è Ese n√∫mero puede estar equivocado o a√∫n no se ha recibido.</div>
    </section>

    <div class="footer-btn">
      <button id="reloadBtn" class="btn-refresh">üîÑ Actualizar</button>
    </div>
  </main>

  <script>
    const urls = {
      Maritimo: [
        'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgbPK4Q40kRpDEZ8oRYQbyqRFZW0gmvPz3z9RcEkJe3HRsGHuraEYsFIKkFwXDYGlzGovo9xDMFbnf/pub?gid=0&single=true&output=csv',
        'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgbPK4Q40kRpDEZ8oRYQbyqRFZW0gmvPz3z9RcEkJe3HRsGHuraEYsFIKkFwXDYGlzGovo9xDMFbnf/pub?gid=74043504&single=true&output=csv'
      ],
      Aereo: [
        'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgbPK4Q40kRpDEZ8oRYQbyqRFZW0gmvPz3z9RcEkJe3HRsGHuraEYsFIKkFwXDYGlzGovo9xDMFbnf/pub?gid=1764022928&single=true&output=csv',
        'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgbPK4Q40kRpDEZ8oRYQbyqRFZW0gmvPz3z9RcEkJe3HRsGHuraEYsFIKkFwXDYGlzGovo9xDMFbnf/pub?gid=624370760&single=true&output=csv'
      ],
      Compra: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgbPK4Q40kRpDEZ8oRYQbyqRFZW0gmvPz3z9RcEkJe3HRsGHuraEYsFIKkFwXDYGlzGovo9xDMFbnf/pub?gid=574168813&single=true&output=csv'
    };

    function normalizeImageUrl(url){
      if(!url)return'';
      url=url.trim();
      let m=url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
      if(m)return`https://drive.google.com/uc?export=view&id=${m[1]}`;
      m=url.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
      if(m)return`https://drive.google.com/uc?export=view&id=${m[1]}`;
      return url;
    }

    function cleanKey(k){return k? k.replace(/\s+/g,'').replace(/[^\w]/g,'').toLowerCase() : ''; }

    function renderTable(data,prefix,headers){
      const thead=document.getElementById(`thead${prefix}`);
      const tbody=document.getElementById(`tbody${prefix}`);
      const empty=document.getElementById(`empty${prefix}`);
      const meta=document.getElementById(`meta${prefix}`);
      thead.innerHTML='';tbody.innerHTML='';
      if(!data.length){empty.style.display='block';meta.textContent='';return;}
      empty.style.display='none';

      // Oculta columna FOTO, deja solo LINK_FOTO
      const headersFiltrados=headers.filter(h=>{
        const key=cleanKey(h);
        if(key==='id')return false;
        if(key.includes('foto') && !key.includes('linkfoto'))return false;
        return true;
      });

      const trHead=document.createElement('tr');
      headersFiltrados.forEach(h=>{const th=document.createElement('th');th.textContent=h;trHead.appendChild(th);});
      thead.appendChild(trHead);

      data.forEach(row=>{
        const tr=document.createElement('tr');
        headersFiltrados.forEach(h=>{
          const key=cleanKey(h);
          let val=row[h]??row[h.trim()]??'';
          const td=document.createElement('td');
          if(key.includes('linkfoto') && val){
            const imgUrl=normalizeImageUrl(val);
            td.innerHTML=`<button class="view-btn" onclick="window.open('${imgUrl}','_blank')">üì∑ Ver foto</button>`;
          }else td.textContent=val;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      meta.textContent=`Mostrando ${data.length} coincidencia(s)`;
    }

    async function searchTracking(kind){
      const input=document.getElementById(`search${kind}`);
      const code=input.value.trim().toLowerCase();
      if(!code)return;
      let urlsToFetch=Array.isArray(urls[kind])?urls[kind]:[urls[kind]];
      let allData=[];
      for(const u of urlsToFetch){
        await new Promise(resolve=>{
          Papa.parse(u+'&t='+Date.now(),{
            download:true,header:true,skipEmptyLines:true,
            complete:res=>{
              allData=allData.concat(res.data||[]);
              resolve();
            },error:()=>resolve()
          });
        });
      }
      const headers=Object.keys(allData[0]||{});
      let result;
      if(kind==='Maritimo'||kind==='Aereo'){
        result=allData.filter(r=>(r['ORDEN']||'').toLowerCase().includes(code));
      }else{
        result=allData.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(code)));
      }
      renderTable(result,kind,headers);
    }

    document.getElementById('reloadBtn').onclick=()=>location.reload();
    ['Maritimo','Aereo','Compra'].forEach(k=>{
      const el=document.getElementById(`search${k}`);
      el.addEventListener('keydown',e=>{if(e.key==='Enter')searchTracking(k);});
    });
  </script>
</body>
</html>
