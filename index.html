<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>MiRCargoTrack | Rastreo</title>

  <style>
    :root{
      --azulClaro:#38bdf8;
      --azulOscuro:#1e3a8a;
      --celesteTxt:#0ea5e9;
      --celesteBg:#e0f2fe;
      --gris:#f1f5f9;
      --gris2:#e2e8f0;
      --blanco:#ffffff;
      --texto:#0f172a;
      --amarillo:#fde68a;
      --amarilloH:#fcd34d;
    }

    body{
      margin:0;
      background:var(--gris);
      font-family: system-ui, -apple-system, Roboto, Arial;
      color:var(--texto);
    }

    /* ========================== HEADER ========================== */
    header{
      background:linear-gradient(90deg,var(--azulClaro),var(--azulOscuro));
      color:white;
      padding:20px 12px 35px;
      text-align:center;
      position:relative;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }

    /* Encabezado reducido 60% en web */
    @media(min-width:700px){
      header{
        padding:15px 12px 25px;
      }
    }

    .flag-left, .flag-right{
      position:absolute;
      top:10px;
      width:120px;
      border-radius:10px;
      box-shadow:0 0 6px rgba(0,0,0,.4);
    }

    .flag-left{ left:12px; }
    .flag-right{ right:12px; }

    /* LOGO */
    .logo svg{
      width:80%;
      max-width:380px;
      margin-top:20px;
    }

    @media(min-width:700px){
      .logo svg{
        max-width:360px;
        margin-top:10px;
      }
    }

    /* ========================== CONTENIDO ========================== */

    .container{
      max-width:900px;
      margin:20px auto;
      padding:0 12px;
      display:flex;
      flex-direction:column;
      gap:20px;
    }

    .card{
      background:white;
      border-radius:14px;
      box-shadow:0 3px 14px rgba(0,0,0,.08);
      border:1px solid var(--gris2);
      padding-bottom:5px;
    }

    .card-title{
      padding:14px;
      font-size:19px;
      font-weight:800;
      background:#fafafa;
      border-bottom:1px solid var(--gris2);
    }

    .card-header{
      padding:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      border-bottom:1px solid var(--gris2);
    }

    .input{
      flex:1;
      background:white;
      border-radius:10px;
      border:1px solid var(--gris2);
      padding:10px 14px;
      display:flex;
      align-items:center;
    }

    .input input{
      border:none;
      width:100%;
      font-size:16px;
      outline:none;
    }

    .btn{
      background:var(--amarillo);
      border:none;
      padding:12px 16px;
      border-radius:10px;
      font-weight:800;
      cursor:pointer;
      font-size:16px;
    }

    .btn:hover{ background:var(--amarilloH); }

    /* TABLAS */
    .table-wrap{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:650px;
    }

    th,td{
      padding:10px;
      border-bottom:1px solid var(--gris2);
      font-size:15px;
    }

    .status-pill{
      background:var(--celesteBg);
      color:var(--celesteTxt);
      padding:4px 10px;
      border-radius:20px;
      font-weight:700;
    }

    /* ========================== VIEW BUTTON ========================== */

    .view-btn{
      background:var(--celesteTxt);
      color:white;
      padding:8px 14px;
      border-radius:8px;
      border:none;
      font-size:14px;
      cursor:pointer;
      font-weight:700;
    }

    /* M√≥vil: ancho completo */
    .detail-actions .view-btn{
      width:100%;
      text-align:center;
    }

    /* Web: botones m√°s peque√±os */
    @media(min-width:601px){
      .detail-actions{
        display:flex;
        flex-direction:row;
        gap:10px;
      }
      .detail-actions .view-btn{
        width:auto !important;
        padding:6px 12px !important;
        font-size:13px !important;
        display:inline-block !important;
      }
    }

    /* Footer */
    .footer-btn{text-align:center;margin:26px;}
    .btn-refresh{
      background:var(--celesteTxt);
      color:white;
      border:none;
      padding:12px 26px;
      border-radius:12px;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
    }

  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>

<!-- ========================== ENCABEZADO ========================== -->

<header>

  <img class="flag-left" src="https://flagcdn.com/us.svg">
  <img class="flag-right" src="https://flagcdn.com/ni.svg">

  <div class="logo">
    <svg viewBox="0 0 520 120">
      <defs>
        <linearGradient id="g" x1="0" x2="1">
          <stop offset="0" stop-color="#38bdf8"/>
          <stop offset="1" stop-color="#1e3a8a"/>
        </linearGradient>
      </defs>
      <g font-family="Inter" text-anchor="middle">
        <text x="260" y="54" font-size="48" font-weight="900" fill="#fff" style="letter-spacing:1px; font-style:italic;">
          MiR<tspan fill="#fde68a">CargoTrack</tspan>
        </text>
        <path d="M70 70 L450 70 L466 86 L70 86 Z" fill="url(#g)" opacity="0.9">
          <animate attributeName="opacity" values="0.4;1;0.4" dur="2.5s" repeatCount="indefinite"/>
        </path>
      </g>
    </svg>
  </div>

</header>

<!-- ========================== CUERPO ========================== -->

<main class="container">

  <!-- ================= MAR√çTIMO ================= -->

  <section class="card">
    <div class="card-title">üö¢ Rastreo Mar√≠timo</div>

    <div class="card-header">
      <div class="input">
        <input id="searchMaritimo" placeholder="N√∫mero de rastreo mar√≠timo">
      </div>
      <button class="btn" onclick="searchTracking('Maritimo')">Buscar</button>
    </div>

    <div id="resultsMaritimo"></div>

    <div class="table-wrap">
      <table>
        <thead id="theadMaritimo"></thead>
        <tbody id="tbodyMaritimo"></tbody>
      </table>
    </div>

    <div id="emptyMaritimo" style="display:none; padding:14px; text-align:center;">
      ‚ùå No encontramos ese n√∫mero.
    </div>
  </section>

  <!-- ================= A√âREO ================= -->

  <section class="card">
    <div class="card-title">‚úàÔ∏è Rastreo A√©reo</div>

    <div class="card-header">
      <div class="input">
        <input id="searchAereo" placeholder="N√∫mero de rastreo a√©reo">
      </div>
      <button class="btn" onclick="searchTracking('Aereo')">Buscar</button>
    </div>

    <div id="resultsAereo"></div>

    <div class="table-wrap">
      <table>
        <thead id="theadAereo"></thead>
        <tbody id="tbodyAereo"></tbody>
      </table>
    </div>

    <div id="emptyAereo" style="display:none; padding:14px; text-align:center;">
      ‚ùå No encontramos ese n√∫mero.
    </div>
  </section>

  <!-- ================= COMPRAS ================= -->

  <section class="card">
    <div class="card-title">üõçÔ∏è Rastreo de compras en l√≠nea</div>

    <div class="card-header">
      <div class="input">
        <input id="searchCompra" placeholder="Nombre o n√∫mero de tracking">
      </div>
      <button class="btn" onclick="searchTracking('Compra')">Buscar</button>
    </div>

    <div id="resultsCompra"></div>

    <div class="table-wrap">
      <table>
        <thead id="theadCompra"></thead>
        <tbody id="tbodyCompra"></tbody>
      </table>
    </div>

    <div id="emptyCompra" style="display:none; padding:14px; text-align:center;">
      ‚ö†Ô∏è Sin resultados.
    </div>
  </section>

  <div class="footer-btn">
    <button class="btn-refresh" onclick="location.reload()">üîÑ Actualizar</button>
  </div>

</main>

<!-- ========================== SCRIPTS ========================== -->

<script>

const urls = {
  Maritimo:[
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=0&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=135469883&single=true&output=csv"
  ],
  Aereo:[
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1149417296&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1429832468&single=true&output=csv"
  ],
  Compra:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=532919355&single=true&output=csv"
};

function normalizeImageUrl(url){
  if(!url) return "";
  url=url.trim();

  let m=url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

  m=url.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
  if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

  return url;
}

// Abrir firma con fondo blanco
function openWhiteViewer(url){
  const win = window.open("", "_blank");
  win.document.write(`
    <html>
      <body style="margin:0; background:white; display:flex; justify-content:center; align-items:center;">
        <img src="${url}" style="max-width:100%; height:auto;">
      </body>
    </html>
  `);
  win.document.close();
}

function safe(r,keys){
  for(const k of keys){ if(r[k]) return r[k]; }
  return "";
}

function renderTable(list,type){
  const thead=document.getElementById(`thead${type}`);
  const tbody=document.getElementById(`tbody${type}`);
  const empty=document.getElementById(`empty${type}`);

  thead.innerHTML="";
  tbody.innerHTML="";

  if(!list.length){
    empty.style.display="block";
    return;
  }
  empty.style.display="none";

  const columns = type==="Compra"
    ? ["Fecha","Tracking #","Nombre","Foto","Agente"]
    : ["Fecha","Status","Foto","Firma","Agente"];

  const thRow=document.createElement("tr");
  columns.forEach(c=>{
    const th=document.createElement("th");
    th.textContent=c;
    thRow.appendChild(th);
  });
  thead.appendChild(thRow);

  list.forEach(r=>{
    const tr=document.createElement("tr");

    const fecha=safe(r,["Fecha","FECHA"]);
    const track=safe(r,["Tracking","Tracking #","Orden","ORDEN"]);
    const nombre=safe(r,["Nombre","Cliente","CLIENTE"]);
    const status=safe(r,["Status","STATUS"]);
    const agente=safe(r,["Agente","AGENTE","Usuario"]);

    const foto=normalizeImageUrl(safe(r,["Web url","Web URL"]));
    const firma=normalizeImageUrl(safe(r,["Firma url","Firma URL"]));

    columns.forEach(col=>{
      const td=document.createElement("td");

      if(col==="Fecha") td.textContent=fecha;
      else if(col==="Tracking #") td.textContent=track;
      else if(col==="Nombre") td.textContent=nombre;
      else if(col==="Agente") td.textContent=agente;

      else if(col==="Status")
        td.innerHTML=status?`<span class="status-pill">${status}</span>`:"";

      else if(col==="Foto")
        td.innerHTML=foto?`<button class="view-btn" onclick="window.open('${foto}','_blank')">üì∑ Ver foto</button>`:"";

      else if(col==="Firma")
        td.innerHTML=firma
          ? `<button class="view-btn" onclick="openWhiteViewer('${firma}')">‚úçÔ∏è Ver firma</button>`
          : "";

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

async function searchTracking(type){
  const input=document.getElementById(`search${type}`);
  const code=input.value.trim().toLowerCase();
  if(!code) return;

  let data=[];
  const links = Array.isArray(urls[type]) ? urls[type] : [urls[type]];

  for(const link of links){
    await new Promise(resolve=>{
      Papa.parse(link+"&t="+Date.now(),{
        download:true,
        header:true,
        skipEmptyLines:true,
        complete:res=>{
          data=data.concat(res.data);
          resolve();
        }
      });
    });
  }

  const filtered = data.filter(r=>{
    const track=safe(r,["Tracking","Tracking #","Orden","ORDEN"]).toLowerCase();
    const name=safe(r,["Nombre","Cliente"]).toLowerCase();
    return track.includes(code) || name.includes(code);
  });

  renderTable(filtered,type);
}

["Maritimo","Aereo","Compra"].forEach(t=>{
  document.getElementById(`search${t}`)
    .addEventListener("keydown",e=>{
      if(e.key==="Enter") searchTracking(t);
    });
});

</script>

</body>
</html>
