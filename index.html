<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIRCARGOTRACK</title>
  <style>
    :root{
      --azul:#1e3a8a; --azul-claro:#38bdf8; --gris:#f1f5f9; --gris-borde:#e2e8f0;
      --texto:#0f172a; --blanco:#ffffff; --amarillo:#fde68a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:#eef2f7;color:var(--texto)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--azul) 0%,#0b245e 100%);color:#fff;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .logo{font-weight:800;letter-spacing:.5px;font-size:20px;text-decoration:none;color:#fff}
    .logo span{border-bottom:3px solid #64a5ff; transform:skewX(-18deg); display:inline-block; padding:2px 6px}
    .grow{flex:1}
    .btn{border:0;border-radius:14px;padding:10px 14px;cursor:pointer}
    .btn-refresh{background:#2c3e75;color:#fff}
    .container{max-width:980px;margin:24px auto;padding:0 14px}
    .card{background:#fff;border:1px solid var(--gris-borde);border-radius:18px;box-shadow:0 4px 14px rgba(0,0,0,.06);margin-bottom:18px;overflow:hidden}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--gris-borde);display:flex;align-items:center;gap:10px}
    .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef6ff;color:#0b5cab;border:1px solid #c7e2ff}
    .bar{display:flex;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--gris-borde)}
    input[type="text"]{flex:1;padding:10px 12px;border:1px solid var(--gris-borde);border-radius:12px;background:#fff}
    .btn-buscar{background:#e2e8f0}
    .btn-buscar:hover{filter:brightness(.95)}
    table{width:100%;border-collapse:collapse}
    thead th{font-size:12px;text-align:left;color:#475569;background:#f8fafc;border-bottom:1px solid var(--gris-borde);padding:10px}
    tbody td{padding:10px;border-bottom:1px solid var(--gris-borde);vertical-align:middle}
    .status{font-weight:700;background:#e6f6fe;color:#035b92;border-radius:999px;padding:4px 10px;display:inline-block}
    .btn-ver{background:var(--azul-claro);color:#fff;border:0;border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:700}
    .muted{color:#64748b;font-size:12px}
    .empty{padding:14px 16px;color:#64748b}
    .foot{padding:10px 16px;font-size:12px;color:#64748b}
  </style>
</head>
<body>
  <header>
    <a class="logo" href="#"><span>MIRCARGOTRACK</span></a>
    <div class="grow"></div>
    <button id="btnRefresh" class="btn btn-refresh">Actualizar</button>
  </header>

  <div class="container">
    <!-- Mar√≠timo -->
    <section class="card" id="sec-maritimo">
      <h2>üö¢ Rastreo Mar√≠timo <span class="tag" id="tag-mar">Listo</span></h2>
      <div class="bar">
        <input id="q-mar" type="text" placeholder="Ingresa tu n√∫mero de rastreo" />
        <button class="btn btn-buscar" id="btn-mar">Buscar</button>
        <span class="muted" id="count-mar"></span>
      </div>
      <div class="table-wrap" id="tbl-mar"></div>
      <div class="foot">Mostrando resultados de la hoja Mar√≠timo.</div>
    </section>

    <!-- A√©reo -->
    <section class="card" id="sec-aereo">
      <h2>‚úàÔ∏è Rastreo A√©reo <span class="tag" id="tag-air">Listo</span></h2>
      <div class="bar">
        <input id="q-air" type="text" placeholder="Ingresa tu n√∫mero de rastreo" />
        <button class="btn btn-buscar" id="btn-air">Buscar</button>
        <span class="muted" id="count-air"></span>
      </div>
      <div class="table-wrap" id="tbl-air"></div>
      <div class="foot">Mostrando resultados de la hoja A√©reo.</div>
    </section>

    <!-- Compra en l√≠nea -->
    <section class="card" id="sec-online">
      <h2>üõí Rastreo de compra en l√≠nea <span class="tag" id="tag-on">Listo</span></h2>
      <div class="bar">
        <input id="q-on" type="text" placeholder="Ingresa tu n√∫mero o nombre" />
        <button class="btn btn-buscar" id="btn-on">Buscar</button>
        <span class="muted" id="count-on"></span>
      </div>
      <div class="table-wrap" id="tbl-on"></div>
      <div class="foot">Mostrando resultados de la hoja Amazon/Recepciones.</div>
    </section>
  </div>

  <script>
    // === URLs CSV (tus mismas hojas) ===
    const URL_MAR = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgbPK4Q40kRpDEZ8oRYQbyqRFZW0gmvPz3z9RcEkJe3HRsGHuraEYsFIKkFwXDYGlzGovo9xDMFbnf/pub?gid=0&single=true&output=csv";
    const URL_AIR = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgbPK4Q40kRpDEZ8oRYQbyqRFZW0gmvPz3z9RcEkJe3HRsGHuraEYsFIKkFwXDYGlzGovo9xDMFbnf/pub?gid=1764022928&single=true&output=csv";
    const URL_ONL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgbPK4Q40kRpDEZ8oRYQbyqRFZW0gmvPz3z9RcEkJe3HRsGHuraEYsFIKkFwXDYGlzGovo9xDMFbnf/pub?gid=574168813&single=true&output=csv";

    // === Utilidades ===
    const parseCSV = (text) => {
      const rows = [];
      let i = 0, cur = "", row = [], inQ = false;
      while (i < text.length) {
        const c = text[i], n = text[i+1];
        if (c === '"' && n === '"') { cur += '"'; i+=2; continue; }
        if (c === '"') { inQ = !inQ; i++; continue; }
        if (!inQ && (c === ',')) { row.push(cur); cur=""; i++; continue; }
        if (!inQ && (c === '\n' || c === '\r')) {
          if (cur.length || row.length) { row.push(cur); rows.push(row); row=[]; cur=""; }
          // consumir \r\n
          if (c === '\r' && n === '\n') i++;
          i++; continue;
        }
        cur += c; i++;
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }
      const headers = rows[0] || [];
      return rows.slice(1).map(r=>{
        const obj = {};
        headers.forEach((h,idx)=> obj[(h||"").trim()] = (r[idx]||"").trim() );
        return obj;
      });
    };

    const getVal = (obj, ...cands) => {
      for (const k of Object.keys(obj)) {
        const K = k.toUpperCase();
        for (const c of cands) {
          if (K.includes(c)) return obj[k];
        }
      }
      return "";
    };

    const byQuery = (rows, q) => {
      if (!q) return rows;
      const qq = q.trim().toLowerCase();
      return rows.filter(r=>{
        const a = getVal(r,'TRACKING','BARCODE','ORDEN');
        const b = getVal(r,'ID');
        const c = getVal(r,'NOMBRE','NAME');
        return (a && a.toLowerCase().includes(qq)) ||
               (b && b.toLowerCase().includes(qq)) ||
               (c && c.toLowerCase().includes(qq));
      });
    };

    const renderTable = (rows, mountId, countId) => {
      const el = document.getElementById(mountId);
      const cnt = document.getElementById(countId);
      if (!rows.length) {
        el.innerHTML = `<div class="empty">No se encontraron resultados.</div>`;
        cnt.textContent = "";
        return;
      }
      cnt.textContent = `Mostrando ${rows.length} coincidencia(s)`;
      const html = [
        `<table>`,
        `<thead><tr>
           <th>FECHA / HORA</th>
           <th>BARCODE / ORDEN</th>
           <th>STATUS</th>
           <th>HORA</th>
           <th>AGENTE</th>
           <th>LINK_FOTO</th>
           <th>ID</th>
         </tr></thead>`,
        `<tbody>`,
        ...rows.map(r=>{
          const fecha = getVal(r,'FECHA','FECHA / HORA','FECHA/HORA');
          const ord   = getVal(r,'BARCODE','ORDEN','TRACKING');
          const st    = getVal(r,'STATUS');
          const hora  = getVal(r,'HORA');
          const agt   = getVal(r,'AGENTE');
          const link  = getVal(r,'LINK_FOTO'); // <- SOLO LINK_FOTO
          const id    = getVal(r,'ID');
          const btn   = link ? `<button class="btn-ver" onclick="window.open('${link}','_blank')">Ver foto</button>` : ``;
          return `<tr>
            <td>${fecha||""}</td>
            <td>${ord||""}</td>
            <td>${st?`<span class="status">${st}</span>`:""}</td>
            <td>${hora||""}</td>
            <td>${agt||""}</td>
            <td>${btn}</td>
            <td>${id||""}</td>
          </tr>`;
        }),
        `</tbody></table>`
      ].join("");
      el.innerHTML = html;
    };

    async function loadAndRender(url, q, mountId, countId, tagId){
      try{
        document.getElementById(tagId).textContent = "Cargando‚Ä¶";
        const res = await fetch(url, {cache:"no-store"});
        const txt = await res.text();
        const rows = parseCSV(txt);
        const filtered = byQuery(rows, q);
        renderTable(filtered, mountId, countId);
        document.getElementById(tagId).textContent = `Mostrando ${filtered.length} coincidencia(s)`;
      }catch(e){
        document.getElementById(mountId).innerHTML = `<div class="empty">Error cargando datos.</div>`;
        document.getElementById(tagId).textContent = "Error";
        console.error(e);
      }
    }

    // === Eventos ===
    const refreshAll = () => {
      loadAndRender(URL_MAR, document.getElementById('q-mar').value, 'tbl-mar','count-mar','tag-mar');
      loadAndRender(URL_AIR, document.getElementById('q-air').value, 'tbl-air','count-air','tag-air');
      loadAndRender(URL_ONL, document.getElementById('q-on').value,  'tbl-on','count-on','tag-on');
    };

    document.getElementById('btnRefresh').addEventListener('click', refreshAll);

    // Buscar por m√≥dulo
    document.getElementById('btn-mar').addEventListener('click', ()=> loadAndRender(URL_MAR, document.getElementById('q-mar').value, 'tbl-mar','count-mar','tag-mar'));
    document.getElementById('btn-air').addEventListener('click', ()=> loadAndRender(URL_AIR, document.getElementById('q-air').value, 'tbl-air','count-air','tag-air'));
    document.getElementById('btn-on').addEventListener('click',  ()=> loadAndRender(URL_ONL, document.getElementById('q-on').value,  'tbl-on','count-on','tag-on'));

    // Enter para buscar
    ['q-mar','q-air','q-on'].forEach(id=>{
      document.getElementById(id).addEventListener('keydown',(e)=>{
        if(e.key==='Enter'){
          if(id==='q-mar') document.getElementById('btn-mar').click();
          if(id==='q-air') document.getElementById('btn-air').click();
          if(id==='q-on')  document.getElementById('btn-on').click();
        }
      });
    });

    // Primera carga
    refreshAll();
  </script>
</body>
</html>
