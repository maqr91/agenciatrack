<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>MiRCargoTrack | Rastreo</title>

  <style>
    :root{
      --azulClaro:#38bdf8; --azulOscuro:#1e3a8a;
      --celesteTxt:#0ea5e9; --celesteBg:#e0f2fe;
      --gris:#f1f5f9; --gris2:#e2e8f0;
      --blanco:#ffffff; --texto:#0f172a;
      --amarilloP√°lido:#fde68a; --amarilloHover:#fcd34d;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--texto);
      background:var(--gris);
    }

    header{
      background:linear-gradient(90deg,var(--azulClaro),var(--azulOscuro));
      color:#fff;
      padding:35px 12px 50px;
      text-align:center;
      position:relative;
      box-shadow:0 2px 8px rgba(0,0,0,.25);
    }

    .flag-left, .flag-right{
      position:absolute;
      top:15px;
      width:70px;
      border-radius:6px;
      box-shadow:0 0 6px rgba(0,0,0,.4);
    }
    .flag-left{ left:10px; }
    .flag-right{ right:10px; }

    /* Logo central */
    .logo svg{
      max-width:85%;
      height:auto;
    }

    /* MOBILE FIRST */
    @media (max-width:600px){
      header{ padding-top:50px; }
      .flag-left { width:55px; left:8px; }
      .flag-right{ width:55px; right:8px; }
    }

    .container{
      max-width:900px;
      margin:20px auto;
      padding:0 12px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    .card{
      background:#fff;
      border-radius:12px;
      border:1px solid var(--gris2);
      box-shadow:0 3px 12px rgba(0,0,0,.08);
    }

    .card-title{
      padding:12px;
      background:#fafafa;
      font-size:17px;
      font-weight:800;
      border-bottom:1px solid var(--gris2);
    }

    .card-header{
      padding:10px;
      border-bottom:1px solid var(--gris2);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .input{
      flex:1;
      display:flex;
      align-items:center;
      background:white;
      border-radius:8px;
      border:1px solid var(--gris2);
      padding:8px 12px;
    }

    .input input{
      border:none;
      width:100%;
      font-size:15px;
      outline:none;
    }

    .btn{
      background:var(--amarilloP√°lido);
      border:none;
      padding:10px 14px;
      border-radius:10px;
      font-size:15px;
      font-weight:700;
      cursor:pointer;
    }
    .btn:hover{
      background:var(--amarilloHover);
    }

    .table-wrap{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }

    table{
      width:100%;
      min-width:640px;
      border-collapse:collapse;
    }
    th,td{
      padding:10px;
      border-bottom:1px solid var(--gris2);
      font-size:14px;
    }

    .status-pill{
      background:var(--celesteBg);
      color:var(--celesteTxt);
      padding:4px 10px;
      border-radius:30px;
      font-weight:700;
    }

    .view-btn{
      background:var(--celesteTxt);
      color:#fff;
      padding:6px 12px;
      border-radius:8px;
      border:none;
      font-size:13px;
      cursor:pointer;
    }

    .footer-btn{
      text-align:center;
      margin:25px;
    }

    .btn-refresh{
      background:var(--celesteTxt);
      color:#fff;
      border:none;
      padding:12px 26px;
      font-weight:800;
      border-radius:12px;
      cursor:pointer;
      font-size:15px;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>

<header>
  <!-- Banderas -->
  <img class="flag-left" src="https://flagcdn.com/us.svg">
  <img class="flag-right" src="https://flagcdn.com/ni.svg">

  <!-- Logo central -->
  <div class="logo">
    <svg viewBox="0 0 520 120">
      <defs>
        <linearGradient id="g" x1="0" x2="1">
          <stop offset="0" stop-color="#38bdf8"/>
          <stop offset="1" stop-color="#1e3a8a"/>
        </linearGradient>
      </defs>
      <g font-family="Inter" text-anchor="middle">
        <text x="260" y="58" font-size="52" font-weight="900" fill="#fff" style="letter-spacing:1px; font-style:italic;">
          MiR<tspan fill="#fde68a">CargoTrack</tspan>
        </text>
        <path d="M70 70 L450 70 L466 86 L70 86 Z" fill="url(#g)" opacity="0.9">
          <animate attributeName="opacity" values="0.4;1;0.4" dur="2.5s" repeatCount="indefinite"/>
        </path>
      </g>
    </svg>
  </div>
</header>

<main class="container">

  <!-- MAR√çTIMO -->
  <section class="card">
    <div class="card-title">üö¢ Rastreo Mar√≠timo</div>

    <div class="card-header">
      <div class="input">
        <input id="searchMaritimo" placeholder="N√∫mero de rastreo mar√≠timo">
      </div>
      <button class="btn" onclick="searchTracking('Maritimo')">Buscar</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead id="theadMaritimo"></thead>
        <tbody id="tbodyMaritimo"></tbody>
      </table>
    </div>

    <div id="emptyMaritimo" class="empty" style="display:none; padding:14px; text-align:center;">
      ‚ùå No encontramos ese n√∫mero.
    </div>
  </section>

  <!-- A√âREO -->
  <section class="card">
    <div class="card-title">‚úàÔ∏è Rastreo A√©reo</div>

    <div class="card-header">
      <div class="input">
        <input id="searchAereo" placeholder="N√∫mero de rastreo a√©reo">
      </div>
      <button class="btn" onclick="searchTracking('Aereo')">Buscar</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead id="theadAereo"></thead>
        <tbody id="tbodyAereo"></tbody>
      </table>
    </div>

    <div id="emptyAereo" class="empty" style="display:none; padding:14px; text-align:center;">
      ‚ùå No encontramos ese n√∫mero.
    </div>
  </section>

  <!-- COMPRAS EN L√çNEA -->
  <section class="card">
    <div class="card-title">üõçÔ∏è Rastreo de compras en l√≠nea</div>

    <div class="card-header">
      <div class="input">
        <input id="searchCompra" placeholder="Nombre o n√∫mero de tracking">
      </div>
      <button class="btn" onclick="searchTracking('Compra')">Buscar</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead id="theadCompra"></thead>
        <tbody id="tbodyCompra"></tbody>
      </table>
    </div>

    <div id="emptyCompra" class="empty" style="display:none; padding:14px; text-align:center;">
      ‚ö†Ô∏è No se encontr√≥ esa compra.
    </div>
  </section>

  <div class="footer-btn">
    <button class="btn-refresh" onclick="location.reload()">üîÑ Actualizar</button>
  </div>

</main>

<script>

const urls = {
  Maritimo: [
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=0&single=true&output=csv',
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=135469883&single=true&output=csv'
  ],
  Aereo: [
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1149417296&single=true&output=csv',
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1429832468&single=true&output=csv'
  ],
  Compra:
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=532919355&single=true&output=csv'
};

function normalizeImageUrl(url){
  if(!url) return '';
  url = url.trim();
  let m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;
  m = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
  if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;
  return url;
}

function safe(r, keys){
  for(const k of keys){
    if(r[k]) return r[k];
  }
  return '';
}

function renderTable(data, type){
  const thead=document.getElementById(`thead${type}`);
  const tbody=document.getElementById(`tbody${type}`);
  const empty=document.getElementById(`empty${type}`);
  const meta=document.getElementById(`meta${type}`);

  thead.innerHTML='';
  tbody.innerHTML='';

  if(!data.length){
    empty.style.display='block';
    if(meta) meta.textContent='';
    return;
  }

  empty.style.display='none';

  const columns = type==='Compra'
    ? ['Fecha','Tracking #','Nombre','Foto','Agente']
    : ['Fecha','Status','Foto','Firma','Agente'];

  const trHead=document.createElement('tr');
  columns.forEach(c=>{
    const th=document.createElement('th');
    th.textContent=c;
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  data.forEach(row=>{
    const tr=document.createElement('tr');

    const fecha=safe(row,['Fecha','FECHA']);
    const track=safe(row,['Tracking','Tracking #','Orden','ORDEN']);
    const status=safe(row,['Status','STATUS']);
    const nombre=safe(row,['Nombre','Cliente']);
    const agente=safe(row,['Agente','AGENTE','Usuario']);

    const foto=normalizeImageUrl(safe(row,['Web url','Web URL']));
    const firma=normalizeImageUrl(safe(row,['Firma url','Firma URL']));

    columns.forEach(col=>{
      const td=document.createElement('td');

      if(col=='Fecha') td.textContent=fecha;
      else if(col=='Tracking #') td.textContent=track;
      else if(col=='Nombre') td.textContent=nombre;
      else if(col=='Agente') td.textContent=agente;
      else if(col==='Status') td.innerHTML=status?`<span class="status-pill">${status}</span>`:'';
      else if(col==='Foto') td.innerHTML=foto?`<button class="view-btn" onclick="window.open('${foto}')">üì∑ Ver foto</button>`:'';
      else if(col==='Firma') td.innerHTML=firma?`<button class="view-btn" onclick="window.open('${firma}')">‚úçÔ∏è Ver firma</button>`:'';

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  if(meta) meta.textContent = `Mostrando ${data.length} coincidencia(s)`;
}

async function searchTracking(type){
  const input=document.getElementById(`search${type}`);
  const code=input.value.trim().toLowerCase();
  if(!code) return;

  let links = Array.isArray(urls[type]) ? urls[type] : [urls[type]];
  let allData=[];

  for(const link of links){
    await new Promise(resolve=>{
      Papa.parse(link + "&t=" + Date.now(), {
        download:true,
        header:true,
        skipEmptyLines:true,
        complete:res=>{
          allData = allData.concat(res.data);
          resolve();
        }
      });
    });
  }

  const result = allData.filter(r=>{
    const track=safe(r,['Tracking','Tracking #','Orden','ORDEN']).toLowerCase();
    const name=safe(r,['Nombre','Cliente']).toLowerCase();
    return track.includes(code) || name.includes(code);
  });

  renderTable(result, type);
}

['Maritimo','Aereo','Compra'].forEach(type=>{
  document.getElementById(`search${type}`).addEventListener('keydown', e=>{
    if(e.key==='Enter') searchTracking(type);
  });
});

</script>

</body>
</html>
