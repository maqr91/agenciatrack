function doGet(e) {
  var expected = PropertiesService.getScriptProperties().getProperty('EMPLOYEE_CODE');

  // ‚úÖ Validaci√≥n de c√≥digo (login simple)
  if (e.parameter.checkCode) {
    return ContentService.createTextOutput(
      e.parameter.checkCode === expected ? 'OK' : 'INVALID'
    ).setMimeType(ContentService.MimeType.TEXT);
  }

  return ContentService.createTextOutput('INVALID').setMimeType(ContentService.MimeType.TEXT);
}

function doPost(e) {
  try {
    var expected = PropertiesService.getScriptProperties().getProperty('EMPLOYEE_CODE');
    var provided = (e.parameter.key || '').trim();
    if (provided !== expected) {
      return ContentService.createTextOutput('‚ùå No autorizado').setMimeType(ContentService.MimeType.TEXT);
    }

    // üìÇ Carpeta de Drive donde se guardan las fotos
    var folder = DriveApp.getFolderById('TU_FOLDER_ID_DE_DRIVE'); // <-- REEMPLAZA

    // üì∏ Archivo subido
    var blob = e.parameter.foto ? e.parameter.foto : (e.files && e.files.foto);
    var tracking = (e.parameter.tracking || '').trim();
    if (!tracking || !blob) {
      return ContentService.createTextOutput('‚ùå Faltan datos').setMimeType(ContentService.MimeType.TEXT);
    }

    // Guardar como TRACKING.jpg
    blob.setName(tracking + '.jpg');
    var file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    var link = file.getUrl();

    // üßæ Actualizar Google Sheets (poner el link en la √∫ltima columna)
    var sheet = SpreadsheetApp.openById('TU_ID_DE_HOJA').getSheets()[0]; // <-- REEMPLAZA
    var data = sheet.getDataRange().getValues();
    var cols = data[0].length;
    var found = false;

    for (var i = 0; i < data.length; i++) {
      if ((data[i][0] + '').trim() === tracking) {
        sheet.getRange(i + 1, cols).setValue(link);
        found = true;
        break;
      }
    }
    if (!found) {
      // Si no existe el tracking, agrega una fila nueva (ajusta columnas seg√∫n tu hoja)
      sheet.appendRow([tracking, '', '', '', link]);
    }

    return ContentService.createTextOutput('‚úÖ Foto subida y guardada en la hoja').setMimeType(ContentService.MimeType.TEXT);
  } catch (err) {
    return ContentService.createTextOutput('‚ùå Error: ' + err).setMimeType(ContentService.MimeType.TEXT);
  }
}
