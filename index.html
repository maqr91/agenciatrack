<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>MiRCargoTrack | Rastreo</title>

  <style>
    :root{
      --azulClaro:#38bdf8; --azulOscuro:#1e3a8a;
      --celesteTxt:#0ea5e9; --celesteBg:#e0f2fe;
      --gris:#f1f5f9; --gris2:#e2e8f0;
      --blanco:#ffffff; --texto:#0f172a;
      --amarilloP√°lido:#fde68a; --amarilloHover:#fcd34d;
    }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--texto);
      background:var(--gris);
    }

    /* === ENCABEZADO AZUL REDUCIDO === */
    header{
      background:linear-gradient(90deg,var(--azulClaro),var(--azulOscuro));
      color:#fff;
      padding:10px 12px 14px;
      text-align:center;
      position:relative;
      box-shadow:0 2px 8px rgba(0,0,0,.25);
    }

    @media (min-width:1024px){
      header{
        padding:8px 12px 10px !important;
      }
    }

    /* === BANDERAS GRANDES === */
    .flag-left, .flag-right{
      position:absolute;
      top:6px;
      width:140px;
      border-radius:10px;
      box-shadow:0 0 8px rgba(0,0,0,.45);
    }
    .flag-left{ left:10px; }
    .flag-right{ right:10px; }

    @media (max-width:600px){
      .flag-left, .flag-right{
        width:110px;
      }
    }

    /* Logo central */
    .logo svg{
      max-width:70%;
      height:auto;
      margin-top:10px;
      margin-bottom:5px;
    }

    .container{
      max-width:900px;
      margin:20px auto;
      padding:0 12px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    .card{
      background:#fff;
      border-radius:12px;
      border:1px solid var(--gris2);
      box-shadow:0 3px 12px rgba(0,0,0,.08);
    }

    .card-title{
      padding:12px;
      background:#fafafa;
      font-size:17px;
      font-weight:800;
      border-bottom:1px solid var(--gris2);
    }

    .card-header{
      padding:10px;
      border-bottom:1px solid var(--gris2);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .input{
      flex:1;
      display:flex;
      align-items:center;
      background:white;
      border-radius:8px;
      border:1px solid var(--gris2);
      padding:8px 12px;
    }

    .input input{
      border:none;
      width:100%;
      font-size:15px;
      outline:none;
    }

    .btn{
      background:var(--amarilloP√°lido);
      border:none;
      padding:10px 14px;
      border-radius:10px;
      font-size:15px;
      font-weight:700;
      cursor:pointer;
    }
    .btn:hover{
      background:var(--amarilloHover);
    }

    .table-wrap{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }

    table{
      width:100%;
      min-width:650px;
      border-collapse:collapse;
    }
    th,td{
      padding:10px;
      border-bottom:1px solid var(--gris2);
      font-size:14px;
    }

    .status-pill{
      background:var(--celesteBg);
      color:var(--celesteTxt);
      padding:4px 10px;
      border-radius:30px;
      font-weight:700;
    }

    .view-btn{
      background:var(--celesteTxt);
      color:#fff;
      padding:6px 12px;
      border-radius:8px;
      border:none;
      font-size:13px;
      cursor:pointer;
    }

    .footer-btn{
      text-align:center;
      margin:25px;
    }

    .btn-refresh{
      background:var(--celesteTxt);
      color:#fff;
      border:none;
      padding:12px 26px;
      font-weight:800;
      border-radius:12px;
      cursor:pointer;
      font-size:15px;
    }

    /* === BLOQUE DE DETALLE PARA M√ìVIL === */
    .detail{
      padding:10px 12px;
      font-size:14px;
      line-height:1.5;
      border-bottom:1px solid var(--gris2);
    }
    .detail strong{
      font-weight:800;
    }
    .detail-actions{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .detail-actions .view-btn{
      width:100%;
      text-align:center;
    }

    /* Solo mostrar detalle en pantallas peque√±as si se quiere ocultar luego algo m√°s */
    @media (min-width:601px){
      .detail{
        /* sigue visible, pero el usuario casi siempre mirar√° la tabla grande */
      }
    }

  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>

<header>
  <img class="flag-left" src="https://flagcdn.com/us.svg">
  <img class="flag-right" src="https://flagcdn.com/ni.svg">

  <div class="logo">
    <svg viewBox="0 0 520 120">
      <defs>
        <linearGradient id="g" x1="0" x2="1">
          <stop offset="0" stop-color="#38bdf8"/>
          <stop offset="1" stop-color="#1e3a8a"/>
        </linearGradient>
      </defs>
      <g font-family="Inter" text-anchor="middle">
        <text x="260" y="58" font-size="50" font-weight="900" fill="#fff" style="letter-spacing:1px; font-style:italic;">
          MiR<tspan fill="#fde68a">CargoTrack</tspan>
        </text>
        <path d="M70 70 L450 70 L466 86 L70 86 Z" fill="url(#g)" opacity="0.8">
          <animate attributeName="opacity" values="0.4;1;0.4" dur="2.5s" repeatCount="indefinite"/>
        </path>
      </g>
    </svg>
  </div>
</header>

<main class="container">

  <!-- MAR√çTIMO -->
  <section class="card">
    <div class="card-title">üö¢ Rastreo Mar√≠timo</div>

    <div class="card-header">
      <div class="input">
        <input id="searchMaritimo" placeholder="N√∫mero de rastreo mar√≠timo">
      </div>
      <button class="btn" onclick="searchTracking('Maritimo')">Buscar</button>
    </div>

    <!-- Resumen para m√≥vil -->
    <div id="detailMaritimo" class="detail" style="display:none;"></div>

    <div class="table-wrap">
      <table>
        <thead id="theadMaritimo"></thead>
        <tbody id="tbodyMaritimo"></tbody>
      </table>
    </div>

    <div id="emptyMaritimo" style="display:none; padding:14px; text-align:center;">
      ‚ùå No encontramos ese n√∫mero.
    </div>
  </section>

  <!-- A√âREO -->
  <section class="card">
    <div class="card-title">‚úàÔ∏è Rastreo A√©reo</div>

    <div class="card-header">
      <div class="input">
        <input id="searchAereo" placeholder="N√∫mero de rastreo a√©reo">
      </div>
      <button class="btn" onclick="searchTracking('Aereo')">Buscar</button>
    </div>

    <!-- Resumen para m√≥vil -->
    <div id="detailAereo" class="detail" style="display:none;"></div>

    <div class="table-wrap">
      <table>
        <thead id="theadAereo"></thead>
        <tbody id="tbodyAereo"></tbody>
      </table>
    </div>

    <div id="emptyAereo" style="display:none; padding:14px; text-align:center;">
      ‚ùå No encontramos ese n√∫mero.
    </div>
  </section>

  <!-- COMPRAS -->
  <section class="card">
    <div class="card-title">üõçÔ∏è Rastreo de compras en l√≠nea</div>

    <div class="card-header">
      <div class="input">
        <input id="searchCompra" placeholder="Nombre o n√∫mero de tracking">
      </div>
      <button class="btn" onclick="searchTracking('Compra')">Buscar</button>
    </div>

    <!-- Resumen para m√≥vil -->
    <div id="detailCompra" class="detail" style="display:none;"></div>

    <div class="table-wrap">
      <table>
        <thead id="theadCompra"></thead>
        <tbody id="tbodyCompra"></tbody>
      </table>
    </div>

    <div id="emptyCompra" style="display:none; padding:14px; text-align:center;">
      ‚ö†Ô∏è No se encontr√≥ esa compra.
    </div>
  </section>

  <div class="footer-btn">
    <button class="btn-refresh" onclick="location.reload()">üîÑ Actualizar</button>
  </div>

</main>

<script>
const urls = {
  Maritimo: [
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=0&single=true&output=csv',
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=135469883&single=true&output=csv'
  ],
  Aereo: [
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1149417296&single=true&output=csv',
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1429832468&single=true&output=csv'
  ],
  Compra:
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=532919355&single=true&output=csv'
};

function normalizeImageUrl(url){
  if(!url) return '';
  url=url.trim();
  let m=url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;
  m=url.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
  if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;
  return url;
}

function openSignatureWhiteBg(url){
  const win=window.open("", "_blank");
  win.document.write(`
    <html>
      <head><title>Firma</title></head>
      <body style="margin:0; background:white; display:flex; justify-content:center; align-items:center;">
        <img src="${url}" style="max-width:100%; height:auto;" />
      </body>
    </html>
  `);
}

function safe(r, keys){
  for(const k of keys){
    if(r[k]) return r[k];
  }
  return '';
}

/* === BLOQUE DE RESUMEN PARA M√ìVIL === */
function renderDetail(row, type){
  const detailEl = document.getElementById(`detail${type}`);
  if(!detailEl) return;

  // Si no hay datos o pantalla grande, limpiamos
  if(!row){
    detailEl.style.display = 'none';
    detailEl.innerHTML = '';
    return;
  }

  const isMobile = window.innerWidth <= 600;
  if(!isMobile){
    // En web lo dejamos opcional (puede mostrarse pero no es cr√≠tico)
    // Si prefieres ocultarlo en web, descomenta:
    // detailEl.style.display = 'none'; detailEl.innerHTML=''; return;
  }

  const fecha  = safe(row,['Fecha','FECHA']);
  const track  = safe(row,['Tracking','Tracking #','Orden','ORDEN']);
  const status = safe(row,['Status','STATUS']);
  const nombre = safe(row,['Nombre','Cliente']);
  const agente = safe(row,['Agente','AGENTE','Usuario']);

  const foto   = normalizeImageUrl(safe(row,['Web url','Web URL']));
  const firma  = normalizeImageUrl(safe(row,['Firma url','Firma URL']));

  let html = '';

  if(type === 'Compra'){
    html += `<div><strong>Fecha:</strong> ${fecha || '-'}</div>`;
    html += `<div><strong>Tracking:</strong> ${track || '-'}</div>`;
    html += `<div><strong>Nombre:</strong> ${nombre || '-'}</div>`;
    html += `<div><strong>Agente:</strong> ${agente || '-'}</div>`;
  } else {
    html += `<div><strong>Fecha:</strong> ${fecha || '-'}</div>`;
    html += `<div><strong>Tracking:</strong> ${track || '-'}</div>`;
    html += `<div><strong>Status:</strong> ${status ? `<span class="status-pill">${status}</span>` : '-'}</div>`;
    html += `<div><strong>Agente:</strong> ${agente || '-'}</div>`;
  }

  html += `<div class="detail-actions">`;
  if(foto){
    html += `<button class="view-btn" onclick="window.open('${foto}','_blank')">üì∑ Ver foto</button>`;
  }
  if(type !== 'Compra' && firma){
    html += `<button class="view-btn" onclick="openSignatureWhiteBg('${firma}')">‚úçÔ∏è Ver firma</button>`;
  }
  html += `</div>`;

  detailEl.innerHTML = html;
  detailEl.style.display = 'block';
}

function renderTable(data, type){
  const thead=document.getElementById(`thead${type}`);
  const tbody=document.getElementById(`tbody${type}`);
  const empty=document.getElementById(`empty${type}`);

  thead.innerHTML='';
  tbody.innerHTML='';

  if(!data.length){
    if(empty) empty.style.display='block';
    renderDetail(null, type);
    return;
  }
  if(empty) empty.style.display='none';

  const columns = type==='Compra'
    ? ['Fecha','Tracking #','Nombre','Foto','Agente']
    : ['Fecha','Status','Foto','Firma','Agente'];

  const trHead=document.createElement('tr');
  columns.forEach(c=>{
    const th=document.createElement('th');
    th.textContent=c;
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  data.forEach(row=>{
    const tr=document.createElement('tr');

    const fecha=safe(row,['Fecha','FECHA']);
    const track=safe(row,['Tracking','Tracking #','Orden','ORDEN']);
    const status=safe(row,['Status','STATUS']);
    const nombre=safe(row,['Nombre','Cliente']);
    const agente=safe(row,['Agente','AGENTE','Usuario']);

    const foto=normalizeImageUrl(safe(row,['Web url','Web URL']));
    const firma=normalizeImageUrl(safe(row,['Firma url','Firma URL']));

    columns.forEach(col=>{
      const td=document.createElement('td');

      if(col==='Fecha') td.textContent=fecha;
      else if(col==='Tracking #') td.textContent=track;
      else if(col==='Nombre') td.textContent=nombre;
      else if(col==='Agente') td.textContent=agente;
      else if(col==='Status') td.innerHTML=status?`<span class="status-pill">${status}</span>`:'';
      else if(col==='Foto') td.innerHTML=foto?`<button class="view-btn" onclick="window.open('${foto}','_blank')">üì∑ Ver foto</button>`:'';
      else if(col==='Firma') td.innerHTML=firma?`<button class="view-btn" onclick="openSignatureWhiteBg('${firma}')">‚úçÔ∏è Ver firma</button>`:'';

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  // Mostrar resumen tipo "primera foto" con el primer resultado
  renderDetail(data[0], type);
}

async function searchTracking(type){
  const input=document.getElementById(`search${type}`);
  const code=input.value.trim().toLowerCase();
  if(!code) return;

  let links=Array.isArray(urls[type])?urls[type]:[urls[type]];
  let allData=[];

  for(const link of links){
    await new Promise(resolve=>{
      Papa.parse(link+"&t="+Date.now(),{
        download:true,
        header:true,
        skipEmptyLines:true,
        complete:res=>{
          allData = allData.concat(res.data || []);
          resolve();
        },
        error:()=>resolve()
      });
    });
  }

  const result=allData.filter(r=>{
    const track=safe(r,['Tracking','Tracking #','Orden','ORDEN']).toLowerCase();
    const name =safe(r,['Nombre','Cliente']).toLowerCase();
    return track.includes(code) || name.includes(code);
  });

  renderTable(result,type);
}

['Maritimo','Aereo','Compra'].forEach(type=>{
  const el=document.getElementById(`search${type}`);
  el.addEventListener('keydown',e=>{
    if(e.key==='Enter') searchTracking(type);
  });
});
</script>

</body>
</html>
