<script>
  const urls = {
    Maritimo: [
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=0&single=true&output=csv',
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=135469883&single=true&output=csv'
    ],
    Aereo: [
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1149417296&single=true&output=csv',
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1429832468&single=true&output=csv'
    ],
    Compra:
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=532919355&single=true&output=csv'
  };

  function normalizeImageUrl(url){
    if(!url) return '';
    url = url.trim();

    let m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

    m = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
    if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

    return url;
  }

  function safe(r, arr){
    for(const a of arr){
      if(r[a] !== undefined) return r[a];
    }
    return '';
  }

  function renderTable(data, prefix){
    const thead = document.getElementById(`thead${prefix}`);
    const tbody = document.getElementById(`tbody${prefix}`);
    const empty = document.getElementById(`empty${prefix}`);
    const meta  = document.getElementById(`meta${prefix}`);

    thead.innerHTML = '';
    tbody.innerHTML = '';

    if(!data.length){
      empty.style.display = 'block';
      meta.textContent = '';
      return;
    }
    empty.style.display = 'none';

    let columnas = [];

    if(prefix === 'Compra'){
      columnas = ['Fecha','Orden','Nombre','Agente'];
    } else {
      columnas = ['Fecha','Orden','Status','Foto','Firma','Agente'];
    }

    const trHead = document.createElement('tr');
    columnas.forEach(c=>{
      const th=document.createElement('th'); 
      th.textContent=c;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    data.forEach(r=>{
      const tr = document.createElement('tr');

      const fecha  = safe(r,['Fecha']);
      const orden  = safe(r,['Orden','ORDEN','Tracking','TRACKING']);
      const status = safe(r,['Status','STATUS']);
      const nombre = safe(r,['Nombre','NOMBRE','Cliente']);
      const agente = safe(r,['Agente','AGENTE','Usuario','USUARIO']);

      const fotoUrl  = normalizeImageUrl(safe(r,['Web url','Web URL']));
      const firmaUrl = normalizeImageUrl(safe(r,['Firma url','Firma URL']));

      columnas.forEach(col=>{
        const td=document.createElement('td');

        if(col==='Fecha') td.textContent = fecha;
        else if(col==='Orden') td.textContent = orden;
        else if(col==='Nombre') td.textContent = nombre;
        else if(col==='Agente') td.textContent = agente;

        else if(col==='Status'){
          td.innerHTML = status ? `<span class="status-pill">${status}</span>` : '';
        }

        else if(col==='Foto'){
          td.innerHTML = fotoUrl
            ? `<button class="view-btn" onclick="window.open('${fotoUrl}','_blank')">üì∑ Ver foto</button>`
            : '';
        }

        else if(col==='Firma'){
          td.innerHTML = firmaUrl
            ? `<button class="view-btn" onclick="window.open('${firmaUrl}','_blank')">‚úçÔ∏è Ver firma</button>`
            : '';
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    meta.textContent = `Mostrando ${data.length} coincidencia(s)`;
  }

  async function searchTracking(kind){
    const input = document.getElementById(`search${kind}`);
    const code = input.value.trim().toLowerCase();
    if(!code) return;

    let urlsToFetch = Array.isArray(urls[kind]) ? urls[kind] : [urls[kind]];
    let allData = [];

    for(const u of urlsToFetch){
      await new Promise(resolve=>{
        Papa.parse(u + '&t=' + Date.now(),{
          download:true,
          header:true,
          skipEmptyLines:true,
          complete:res=>{
            allData = allData.concat(res.data || []);
            resolve();
          },
          error:()=>resolve()
        });
      });
    }

    let result;

    if(kind === 'Maritimo' || kind === 'Aereo'){
      result = allData.filter(r=>{
        const orden = safe(r,['Orden','ORDEN','Tracking']).toLowerCase();
        return orden.includes(code);
      });
    } else {
      result = allData.filter(r=>{
        return Object.values(r).some(v=>String(v).toLowerCase().includes(code));
      });
    }

    renderTable(result, kind);
  }

  document.getElementById('reloadBtn').onclick = () => location.reload();

  ['Maritimo','Aereo','Compra'].forEach(k=>{
    const el=document.getElementById(`search${k}`);
    el.addEventListener('keydown', e=>{
      if(e.key==='Enter') searchTracking(k);
    });
  });
</script>
