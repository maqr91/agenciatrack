<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>MiRCargoTrack | Rastreo</title>

  <style>
    :root{
      --azulClaro:#38bdf8;
      --azulOscuro:#1e3a8a;
      --celesteTxt:#0ea5e9;
      --celesteBg:#e0f2fe;
      --gris:#f1f5f9;
      --gris2:#e2e8f0;
      --blanco:#ffffff;
      --texto:#0f172a;
      --amarillo:#fde68a;
      --amarilloH:#fcd34d;
    }

    body{
      margin:0;
      background:var(--gris);
      font-family: system-ui, -apple-system, Roboto, Arial;
      color:var(--texto);
    }

    /* ========================== HEADER ========================== */
    header{
      background:linear-gradient(90deg,var(--azulClaro),var(--azulOscuro));
      color:white;
      padding:20px 12px 35px;
      text-align:center;
      position:relative;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }

    @media(min-width:700px){
      header{
        padding:15px 12px 25px;
      }
    }

    .flag-left, .flag-right{
      position:absolute;
      top:10px;
      width:120px;
      border-radius:10px;
      box-shadow:0 0 6px rgba(0,0,0,.4);
    }

    .flag-left{ left:12px; }
    .flag-right{ right:12px; }

    .logo svg{
      width:80%;
      max-width:380px;
      margin-top:20px;
    }

    @media(min-width:700px){
      .logo svg{
        max-width:360px;
        margin-top:10px;
      }
    }

    /* ========================== CONTENIDO ========================== */
    .container{
      max-width:900px;
      margin:20px auto;
      padding:0 12px;
      display:flex;
      flex-direction:column;
      gap:20px;
    }

    .card{
      background:white;
      border-radius:14px;
      box-shadow:0 3px 14px rgba(0,0,0,.08);
      border:1px solid var(--gris2);
      padding-bottom:5px;
    }

    .card-title{
      padding:14px;
      font-size:19px;
      font-weight:800;
      background:#fafafa;
      border-bottom:1px solid var(--gris2);
    }

    .card-header{
      padding:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      border-bottom:1px solid var(--gris2);
    }

    .input{
      flex:1;
      background:white;
      border-radius:10px;
      border:1px solid var(--gris2);
      padding:10px 14px;
      display:flex;
      align-items:center;
    }

    .input input{
      border:none;
      width:100%;
      font-size:16px;
      outline:none;
    }

    .btn{
      background:var(--amarillo);
      border:none;
      padding:12px 16px;
      border-radius:10px;
      font-weight:800;
      cursor:pointer;
      font-size:16px;
      width:auto;
    }

    .btn:hover{ background:var(--amarilloH); }

    .result-block{
      padding:16px 16px;
      border-bottom:1px solid var(--gris2);
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .result-block:last-child{
      border-bottom:none;
    }

    .status-pill{
      background:var(--celesteBg);
      color:var(--celesteTxt);
      padding:4px 10px;
      border-radius:20px;
      font-weight:700;
    }

    .view-btn{
      background:var(--celesteTxt);
      color:white;
      padding:10px 14px;
      border-radius:10px;
      border:none;
      font-size:15px;
      cursor:pointer;
      font-weight:700;
      width:100%;
      margin-top:4px;
    }

    .detail-actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }

    @media(min-width:620px){
      .detail-actions{
        flex-direction:row;
      }
      .detail-actions .view-btn{
        width:auto;
      }
    }

    /* MOBILE FIX */
    @media(max-width:700px){
      .container{
        padding:0 10px;
        margin-top:10px;
        gap:14px;
      }

      header{
        padding:14px 12px 22px;
      }

      .flag-left, .flag-right{
        width:88px;
        top:6px;
      }

      .logo svg{
        margin-top:6px;
        max-width:260px;
      }
    }

  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

</head>

<body>

<header>
  <img class="flag-left" src="https://flagcdn.com/us.svg">
  <img class="flag-right" src="https://flagcdn.com/ni.svg">

  <div class="logo">
    <svg viewBox="0 0 520 120">
      <defs><linearGradient id="g" x1="0" x2="1">
        <stop offset="0" stop-color="#38bdf8"/>
        <stop offset="1" stop-color="#1e3a8a"/>
      </linearGradient></defs>
      <g font-family="Inter" text-anchor="middle">
        <text x="260" y="54" font-size="48" font-weight="900" fill="#fff" style="letter-spacing:1px; font-style:italic;">
          MiR<tspan fill="#fde68a">CargoTrack</tspan>
        </text>
        <path d="M70 70 L450 70 L466 86 L70 86 Z" fill="url(#g)" opacity="0.9">
          <animate attributeName="opacity" values="0.4;1;0.4" dur="2.5s" repeatCount="indefinite"/>
        </path>
      </g>
    </svg>
  </div>
</header>

<main class="container">

  <!-- ================= MAR√çTIMO ================= -->
  <section class="card">
    <div class="card-title">üö¢ Rastreo Mar√≠timo</div>

    <div class="card-header">
      <div class="input">
        <input id="searchMaritimo" placeholder="N√∫mero de rastreo mar√≠timo">
      </div>
      <button class="btn" onclick="searchTracking('Maritimo')">Buscar</button>
    </div>

    <div id="resultsMaritimo"></div>

    <div id="emptyMaritimo" style="display:none; padding:14px; text-align:center;">
      ‚ùå No encontramos ese n√∫mero.
    </div>
  </section>

  <!-- ================= A√âREO ================= -->
  <section class="card">
    <div class="card-title">‚úàÔ∏è Rastreo A√©reo</div>

    <div class="card-header">
      <div class="input">
        <input id="searchAereo" placeholder="N√∫mero de rastreo a√©reo">
      </div>
      <button class="btn" onclick="searchTracking('Aereo')">Buscar</button>
    </div>

    <div id="resultsAereo"></div>

    <div id="emptyAereo" style="display:none; padding:14px; text-align:center;">
      ‚ùå No encontramos ese n√∫mero.
    </div>
  </section>

  <!-- ================= COMPRAS ================= -->
  <section class="card">
    <div class="card-title">üõçÔ∏è Rastreo de compras en l√≠nea</div>

    <div class="card-header">
      <div class="input">
        <input id="searchCompra" placeholder="Nombre o n√∫mero de tracking">
      </div>
      <button class="btn" onclick="searchTracking('Compra')">Buscar</button>
    </div>

    <div id="resultsCompra"></div>

    <div id="emptyCompra" style="display:none; padding:14px; text-align:center;">
      ‚ö†Ô∏è Sin resultados.
    </div>
  </section>

</main>

<script>

const urls = {
  Maritimo:[
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=0&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=135469883&single=true&output=csv"
  ],
  Aereo:[
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1149417296&single=true&output=csv",
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1429832468&single=true&output=csv"
  ],
  Compra:
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=532919355&single=true&output=csv"
};

function normalizeImageUrl(url){
  if(!url) return "";
  url = url.trim();

  // Normal: /file/d/ID/
  let m = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

  // open?id=ID
  m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

  // googleusercontent ‚Üí directo
  if(url.includes("googleusercontent")) return url;

  return url;
}

function safe(r,keys){
  for(const k of keys){ if(r[k]) return r[k]; }
  return "";
}

function renderTable(list,type){
  const container = document.getElementById(`results${type}`);
  const empty = document.getElementById(`empty${type}`);

  container.innerHTML="";
  empty.style.display="none";

  if(!list.length){
    empty.style.display="block";
    return;
  }

  // COMPRAS: limitar a 40
  if(type === "Compra"){
    list = list.slice(0,40);
  }

  list.forEach(r=>{
    const fecha = safe(r,["Fecha","FECHA"]);
    const track = safe(r,["Tracking","Tracking #","Orden","ORDEN"]);
    const nombre = safe(r,["Nombre","Cliente","CLIENTE"]);
    const status = safe(r,["Status","STATUS"]);
    const agente = safe(r,["Agente","AGENTE","Usuario"]);

    const foto = normalizeImageUrl(safe(r,["Web url","Web URL"]));
    const firma = normalizeImageUrl(safe(r,["Firma url","Firma URL"]));

    let html = `
      <div class="result-block">
        <p><strong>Fecha:</strong> ${fecha}</p>
        <p><strong>Tracking:</strong> ${track}</p>
    `;

    if(type === "Compra"){
      html += `<p><strong>Nombre:</strong> ${nombre}</p>`;
      html += `<p><strong>Agente:</strong> ${agente}</p>`;
    } else {
      html += `<p><strong>Status:</strong> <span class="status-pill">${status}</span></p>`;
      html += `<p><strong>Agente:</strong> ${agente}</p>`;
    }

    html += `<div class="detail-actions">`;

    if(foto){
      html += `<button class="view-btn" onclick="window.open('${foto}','_blank')">üì∑ Ver foto</button>`;
    }

    if(type !== "Compra" && firma){
      html += `<button class="view-btn" onclick="window.open('${firma}','_blank')">‚úçÔ∏è Ver firma</button>`;
    }

    html += `</div></div>`;

    container.innerHTML += html;
  });
}

async function searchTracking(type){
  const input=document.getElementById(`search${type}`);
  const code=input.value.trim().toLowerCase();
  if(!code) return;

  let data=[];
  const links = Array.isArray(urls[type]) ? urls[type] : [urls[type]];

  for(const link of links){
    await new Promise(resolve=>{
      Papa.parse(link+"&t="+Date.now(),{
        download:true,
        header:true,
        skipEmptyLines:true,
        complete:res=>{
          data=data.concat(res.data);
          resolve();
        }
      });
    });
  }

  const filtered = data.filter(r=>{
    const track=safe(r,["Tracking","Tracking #","Orden","ORDEN"]).toLowerCase();
    const name=safe(r,["Nombre","Cliente"]).toLowerCase();
    return track.includes(code) || name.includes(code);
  });

  renderTable(filtered,type);
}

["Maritimo","Aereo","Compra"].forEach(t=>{
  document.getElementById(`search${t}`)
    .addEventListener("keydown",e=>{
      if(e.key==="Enter") searchTracking(t);
    });
});

</script>

</body>
</html>
