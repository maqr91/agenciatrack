<script>
  const urls = {
    Maritimo: [
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=0&single=true&output=csv',
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=135469883&single=true&output=csv'
    ],
    Aereo: [
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1149417296&single=true&output=csv',
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=1429832468&single=true&output=csv'
    ],
    Compra:
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vT2i-JMsQ4G2mXMfdEyihWcNeI8gzXDIWsSxOta60eGa-NgNDOshNojOB6mYxdHPOWkLKwGWZsdnfIL/pub?gid=532919355&single=true&output=csv'
  };

  function normalizeImageUrl(url){
    if(!url) return '';
    url = url.trim();

    let m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

    m = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
    if(m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

    return url;
  }


  // üîµ Funci√≥n din√°mica para renderizar
  function renderTable(data, prefix){
    const thead = document.getElementById(`thead${prefix}`);
    const tbody = document.getElementById(`tbody${prefix}`);
    const empty = document.getElementById(`empty${prefix}`);
    const meta  = document.getElementById(`meta${prefix}`);

    thead.innerHTML = '';
    tbody.innerHTML = '';

    if(!data.length){
      empty.style.display = 'block';
      meta.textContent = '';
      return;
    }
    empty.style.display = 'none';

    // üîµ Columnas seg√∫n el tipo de rastreo
    let columnas = [];

    if(prefix === 'Compra'){
      // SOLO ESTAS 4 EN COMPRA
      columnas = ['Fecha','Orden','Nombre','Agente'];
    } else {
      // A√©reo y Mar√≠timo = igual pero agregando Agente
      columnas = ['Fecha','Orden','Status','Foto','Firma','Agente'];
    }

    // Render encabezado
    const trHead = document.createElement('tr');
    columnas.forEach(h=>{
      const th = document.createElement('th');
      th.textContent = h;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    // Render filas
    data.forEach(row=>{
      const tr = document.createElement('tr');

      const fecha   = row['Fecha'] || '';
      const orden   = row['Orden'] || row['ORDEN'] || row['Tracking'] || '';
      const status  = row['Status'] || row['STATUS'] || '';
      const nombre  = row['Nombre'] || row['NOMBRE'] || '';
      const agente  = row['Agente'] || row['AGENTE'] || '';

      const fotoUrl  = normalizeImageUrl(row['Web url']   || row['Web URL']   || '');
      const firmaUrl = normalizeImageUrl(row['Firma url'] || row['Firma URL'] || '');

      columnas.forEach(col=>{
        const td = document.createElement('td');

        if(col === 'Fecha') td.textContent = fecha;
        else if(col === 'Orden') td.textContent = orden;
        else if(col === 'Nombre') td.textContent = nombre;
        else if(col === 'Agente') td.textContent = agente;

        else if(col === 'Status'){
          td.innerHTML = status
            ? `<span class="status-pill">${status}</span>`
            : '';
        }

        else if(col === 'Foto'){
          td.innerHTML = fotoUrl
            ? `<button class="view-btn" onclick="window.open('${fotoUrl}','_blank')">üì∑ Ver foto</button>`
            : '';
        }

        else if(col === 'Firma'){
          td.innerHTML = firmaUrl
            ? `<button class="view-btn" onclick="window.open('${firmaUrl}','_blank')">‚úçÔ∏è Ver firma</button>`
            : '';
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    meta.textContent = `Mostrando ${data.length} coincidencia(s)`;
  }


  async function searchTracking(kind){
    const input = document.getElementById(`search${kind}`);
    const code = input.value.trim().toLowerCase();
    if(!code) return;

    let urlsToFetch = Array.isArray(urls[kind]) ? urls[kind] : [urls[kind]];
    let allData = [];

    for (const u of urlsToFetch) {
      await new Promise(resolve=>{
        Papa.parse(u + '&t=' + Date.now(), {
          download:true,
          header:true,
          skipEmptyLines:true,
          complete:res=>{
            allData = allData.concat(res.data || []);
            resolve();
          },
          error:()=>resolve()
        });
      });
    }

    let result;

    if(kind === 'Maritimo' || kind === 'Aereo'){
      result = allData.filter(r=>{
        const orden = (r['Orden'] || r['ORDEN'] || '').toLowerCase();
        return orden.includes(code);
      });
    } else {
      result = allData.filter(r=>{
        const vals = Object.values(r).map(v=>String(v).toLowerCase());
        return vals.some(v=>v.includes(code));
      });
    }

    renderTable(result, kind);
  }

  document.getElementById('reloadBtn').onclick = () => location.reload();

  ['Maritimo','Aereo','Compra'].forEach(k=>{
    const el = document.getElementById(`search${k}`);
    el.addEventListener('keydown', e=>{
      if(e.key === 'Enter') searchTracking(k);
    });
  });
</script>
